-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local StarterGui = game:GetService("StarterGui")
local lp = Players.LocalPlayer

-- GUI CREATION - Persistent across character death
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "FlingGUI"
screenGui.ResetOnSpawn = false  -- Prevents GUI from disappearing on death
screenGui.Parent = lp:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 320, 0, 210)
frame.Position = UDim2.new(0.5, -160, 0.5, -105)
frame.AnchorPoint = Vector2.new(0.5, 0.5)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.BorderSizePixel = 0
frame.Parent = screenGui

local title = Instance.new("TextLabel")
title.Text = "Universal Fling - Made By Finny <3"
title.Size = UDim2.new(1, 0, 0, 25)
title.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
title.TextColor3 = Color3.new(1, 1, 1)
title.Font = Enum.Font.GothamBold
title.TextSize = 14
title.Parent = frame

local inputBox = Instance.new("TextBox")
inputBox.Name = "TargetInput"
inputBox.PlaceholderText = "Username or UserID"
inputBox.Size = UDim2.new(0.9, 0, 0, 25)
inputBox.Position = UDim2.new(0.05, 0, 0.15, 0)
inputBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
inputBox.TextColor3 = Color3.new(1, 1, 1)
inputBox.TextWrapped = true
inputBox.Parent = frame

-- Tooltip for input box
local inputTip = Instance.new("TextLabel")
inputTip.Text = "Enter username or UserID to fling a specific person, or leave blank to fling everyone"
inputTip.Size = UDim2.new(0.9, 0, 0, 30)
inputTip.Position = UDim2.new(0.05, 0, 0.25, 0)
inputTip.TextColor3 = Color3.new(0.7, 0.7, 0.7)
inputTip.BackgroundTransparency = 1
inputTip.Font = Enum.Font.Gotham
inputTip.TextSize = 11
inputTip.TextWrapped = true
inputTip.Visible = false
inputTip.Parent = frame

-- Show/hide tooltip
inputBox.Focused:Connect(function()
    inputTip.Visible = true
end)

inputBox.FocusLost:Connect(function()
    inputTip.Visible = false
end)

local flingButton = Instance.new("TextButton")
flingButton.Text = "FLING"
flingButton.Size = UDim2.new(0.9, 0, 0, 30)
flingButton.Position = UDim2.new(0.05, 0, 0.35, 0)
flingButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
flingButton.Font = Enum.Font.GothamBold
flingButton.TextColor3 = Color3.new(1, 1, 1)
flingButton.TextSize = 14
flingButton.Parent = frame

local warningLabel = Instance.new("TextLabel")
warningLabel.Text = "Note: Using this script may kill your player due to following the target!"
warningLabel.Size = UDim2.new(0.9, 0, 0, 40)
warningLabel.Position = UDim2.new(0.05, 0, 0.55, 0)
warningLabel.TextColor3 = Color3.new(1, 0.5, 0.5)
warningLabel.BackgroundTransparency = 1
warningLabel.Font = Enum.Font.Gotham
warningLabel.TextSize = 12
warningLabel.TextWrapped = true
warningLabel.Parent = frame

local statusLabel = Instance.new("TextLabel")
statusLabel.Text = "Status: Ready"
statusLabel.Size = UDim2.new(0.9, 0, 0, 20)
statusLabel.Position = UDim2.new(0.05, 0, 0.8, 0)
statusLabel.TextColor3 = Color3.new(0, 1, 0)
statusLabel.BackgroundTransparency = 1
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextSize = 12
statusLabel.Parent = frame

-- Make GUI draggable
local dragging, dragInput, dragStart, startPos

frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = frame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

frame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- FLING SETTINGS
local FLING_POWER = 10000
local FLING_DURATION = 1  -- 1 second per target

-- Roblox notification function
local function sendNotification(title, text, duration)
    StarterGui:SetCore("SendNotification", {
        Title = title,
        Text = text,
        Duration = duration or 5
    })
end

local function getTargetPlayer()
    local inputText = string.gsub(inputBox.Text, "%s+", "")
    if inputText == "" then
        return nil -- Target everyone
    end

    -- Try to convert input to number (for UserID)
    local inputNumber = tonumber(inputText)
    
    for _, player in ipairs(Players:GetPlayers()) do
        -- Check if input matches username (case-insensitive)
        if string.lower(player.Name) == string.lower(inputText) then
            return player
        end
        
        -- Check if input matches UserID (as number or string)
        if tostring(player.UserId) == inputText or player.UserId == inputNumber then
            return player
        end
    end
    return nil
end

local function getCharacterModel(player)
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        return player.Character
    end
    return nil
end

local function attachToTarget(targetHRP)
    local char = lp.Character
    if not char then return false end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return false end
    
    -- Teleport directly to target
    hrp.CFrame = targetHRP.CFrame
    
    -- Create weld to attach to target
    local weld = Instance.new("Weld")
    weld.Part0 = hrp
    weld.Part1 = targetHRP
    weld.C0 = CFrame.new()
    weld.C1 = CFrame.new()
    weld.Parent = hrp
    
    -- Disable local movement
    local humanoid = char:FindFirstChild("Humanoid")
    if humanoid then
        humanoid.PlatformStand = true
    end
    
    return weld
end

local function applyFlingForce(targetHRP)
    -- Create fling part at target's position
    local flingPart = Instance.new("Part")
    flingPart.Size = Vector3.new(2, 2, 2)
    flingPart.Position = targetHRP.Position
    flingPart.Anchored = false
    flingPart.CanCollide = false
    flingPart.Transparency = 1
    flingPart.Parent = workspace
    
    -- Apply extreme force
    local bodyVelocity = Instance.new("BodyVelocity")
    bodyVelocity.Velocity = Vector3.new(
        math.random(-FLING_POWER, FLING_POWER),
        math.random(FLING_POWER/2, FLING_POWER),
        math.random(-FLING_POWER, FLING_POWER)
    )
    bodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
    bodyVelocity.P = 100000
    bodyVelocity.Parent = flingPart
    
    -- Attach fling part to target
    local flingWeld = Instance.new("Weld")
    flingWeld.Part0 = targetHRP
    flingWeld.Part1 = flingPart
    flingWeld.C0 = CFrame.new()
    flingWeld.Parent = targetHRP
    
    -- Cleanup
    game:GetService("Debris"):AddItem(flingPart, 0.5)
    game:GetService("Debris"):AddItem(flingWeld, 0.5)
    
    return bodyVelocity
end

local function flingTarget(target, duration)
    local char = getCharacterModel(target)
    if not char then return false end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return false end
    
    -- Attach to target
    local weld = attachToTarget(hrp)
    if not weld then return false end
    
    -- Apply fling force
    local bodyVelocity = applyFlingForce(hrp)
    
    -- Maintain attachment for duration
    local startTime = os.clock()
    while os.clock() - startTime < duration do
        -- Reapply force constantly
        bodyVelocity.Velocity = Vector3.new(
            math.random(-FLING_POWER, FLING_POWER),
            math.random(FLING_POWER/2, FLING_POWER),
            math.random(-FLING_POWER, FLING_POWER)
        )
        RunService.Heartbeat:Wait()
    end
    
    -- Cleanup
    weld:Destroy()
    local humanoid = lp.Character:FindFirstChild("Humanoid")
    if humanoid then
        humanoid.PlatformStand = false
    end
    
    return true
end

-- MAIN FLING FUNCTION
local function executeFling()
    -- Save initial position BEFORE anything else
    local initialPosition = nil
    if lp.Character and lp.Character:FindFirstChild("HumanoidRootPart") then
        initialPosition = lp.Character.HumanoidRootPart.CFrame
        print("Saved initial position: "..tostring(initialPosition))
    else
        print("Could not save initial position - character not ready")
    end
    
    -- UI feedback
    statusLabel.Text = "Status: Starting fling sequence..."
    statusLabel.TextColor3 = Color3.new(1, 1, 0)
    flingButton.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
    flingButton.Text = "FLINGING..."
    
    local targetPlayer = getTargetPlayer()
    local targets = {}
    local startTime = os.clock()
    
    if targetPlayer then
        -- Single target
        table.insert(targets, targetPlayer)
        sendNotification("Fling Started", "Flinging: "..targetPlayer.Name, 3)
    else
        -- All players
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= lp then
                table.insert(targets, player)
            end
        end
        sendNotification("Fling Started", "Flinging all players ("..#targets..")", 3)
    end
    
    local totalTargets = #targets
    if totalTargets == 0 then
        statusLabel.Text = "Status: No targets found!"
        statusLabel.TextColor3 = Color3.new(1, 0, 0)
        flingButton.Text = "FLING"
        return
    end
    
    -- Process each target
    for idx, target in ipairs(targets) do
        statusLabel.Text = string.format("Flinging: %s (%d/%d)", target.Name, idx, totalTargets)
        
        -- Attach and fling target for 1 second
        local success = flingTarget(target, FLING_DURATION)
        
        if success then
            -- Print and update status
            local message = string.format("[%s] %s has been flung!", os.date("%H:%M:%S"), target.Name)
            print(message)
            statusLabel.Text = message
        end
    end
    
    -- Calculate total time
    local endTime = os.clock()
    local totalTime = string.format("%.2f", endTime - startTime)
    local completionMessage = string.format("Fling complete! %d targets in %s seconds", totalTargets, totalTime)
    
    -- Final UI update
    statusLabel.Text = completionMessage
    statusLabel.TextColor3 = Color3.new(0, 1, 0)
    flingButton.Text = "FLING"
    print(completionMessage)
    
    -- Send completion notification
    sendNotification("Fling Complete", completionMessage, 5)
    
    -- Return to initial position (with character safety)
    if initialPosition then
        -- Wait for character to exist if needed
        if not lp.Character then
            lp.CharacterAdded:Wait()
        end
        
        -- Wait for HRP to exist
        if lp.Character then
            local hrp = lp.Character:FindFirstChild("HumanoidRootPart")
            if not hrp then
                lp.Character:WaitForChild("HumanoidRootPart", 5)
                hrp = lp.Character:FindFirstChild("HumanoidRootPart")
            end
            
            if hrp then
                hrp.CFrame = initialPosition
                statusLabel.Text = completionMessage.." - Teleported back!"
                print("Teleported back to initial position")
            else
                warn("Failed to teleport back: HRP not found")
                statusLabel.Text = completionMessage.." - Teleport failed!"
            end
        else
            warn("Character not found after waiting")
            statusLabel.Text = completionMessage.." - Teleport failed!"
        end
    else
        statusLabel.Text = completionMessage.." - No position saved!"
    end
    
    -- Button animation
    local tween = TweenService:Create(flingButton, TweenInfo.new(0.5), {BackgroundColor3 = Color3.fromRGB(200, 50, 50)})
    tween:Play()
    
    -- Reset status after delay
    task.wait(3)
    statusLabel.Text = "Status: Ready"
end

-- CONNECT BUTTON
flingButton.MouseButton1Click:Connect(executeFling)

-- CLOSE BUTTON
local closeButton = Instance.new("TextButton")
closeButton.Text = "X"
closeButton.Size = UDim2.new(0, 20, 0, 20)
closeButton.Position = UDim2.new(1, -20, 0, 0)
closeButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
closeButton.Font = Enum.Font.GothamBold
closeButton.TextColor3 = Color3.new(1, 1, 1)
closeButton.TextSize = 12
closeButton.Parent = frame

closeButton.MouseButton1Click:Connect(function()
    screenGui:Destroy()
end)
